# Coffeeshop Data Exploration

**1. How much revenue was generated on each item sold in each transaction in April 2019?**

```sql
SELECT ot.*, CAST(RIGHT(current_retail_price, LENGTH(current_retail_price) - 1) AS numeric) AS price, CAST(RIGHT(current_retail_price, LENGTH(current_retail_price) - 1) AS numeric) * quantity AS revenue 
FROM operations.transactions AS ot
INNER JOIN operations.products AS op
ON ot.product_id = op.product_id;
```
Answer:
For the first 10 rows:
| sales_outlet_id | transaction_date | transaction_sn | transaction_time | staff_id | customer_id | order_no | item_no | product_id | quantity | price | revenue |
|-----------------|------------------|-----------------|-------------------|----------|-------------|----------|---------|------------|----------|-------|---------|
| 3               | "2019-04-10"     | 86              | "07:16:08"        | 19       | 295         | 1        | 1       | 42         | 1        | 2.50  | 2.50    |
| 3               | "2019-04-13"     | 27              | "07:34:37"        | 14       | 134         | 1        | 1       | 58         | 1        | 3.50  | 3.50    |
| 3               | "2019-04-18"     | 326             | "10:55:44"        | 14       | 633         | 1        | 1       | 37         | 1        | 3.00  | 3.00    |
| 3               | "2019-04-22"     | 3515            | "13:28:12"        | 20       | 420         | 1        | 1       | 51         | 2        | 3.00  | 6.00    |
| 3               | "2019-04-23"     | 620             | "17:44:25"        | 14       | 368         | 1        | 1       | 39         | 1        | 4.25  | 4.25    |
| 3               | "2019-04-23"     | 3333            | "13:53:15"        | 14       | 527         | 1        | 1       | 38         | 2        | 3.75  | 7.50    |
| 3               | "2019-04-25"     | 3468            | "08:06:29"        | 14       | 177         | 1        | 1       | 46         | 2        | 2.50   |5.00    |
| 3               | "2019-04-26"    	|1072            	|"14:54:32"     	|16     	|426          	|1         	|1         	|27          	|2         	|3.50  	|7.00    |
|3               	|"2019-04-27"     	|309            	|"11:22:32"     	|14     	|386          	|1         	|1         	|50          	|2         	|2.50  	|5.00    |
|5               	|"2019-04-13"     	|96            	|"10:29:39"     	|30     	|5446         	|1         	|1         	|44          	|1         	|2.50  	|2.50    |

***

**2. How much revenue was generated on each transaction in April 2019? A unique transaction (for a particular store on a particular date) is represented by the transaction_sn, sales_outlet_id and transaction_date fields in the transactions table. A transaction consists of orders and items being sold.**

```sql
SELECT transaction_sn, sales_outlet_id, transaction_date, SUM(CAST(RIGHT(current_retail_price, LENGTH(current_retail_price) - 1) AS numeric) * quantity) AS revenue
FROM operations.transactions AS ot
INNER JOIN operations.products AS op
ON ot.product_id = op.product_id
GROUP BY transaction_sn, sales_outlet_id, transaction_date
ORDER BY transaction_sn, sales_outlet_id, transaction_date;
```
Answer:
For the first 10 rows:
| transaction_sn | sales_outlet_id | transaction_date | revenue |
|----------------|-----------------|-------------------|---------|
| 1              | 3               | "2019-04-05"      | 5.80    |
| 1              | 3               | "2019-04-06"      | 5.00    |
| 1              | 3               | "2019-04-07"      | 3.00    |
| 1              | 3               | "2019-04-08"      | 3.10    |
| 1              | 3               | "2019-04-09"      | 29.90   |
| 1              | 3               | "2019-04-10"      | 5.00    |
| 1              | 3               | "2019-04-11"      | 18.40   |
| 1              | 3               | "2019-04-12"      | 9.00    |
| 1              | 3               | "2019-04-13"      | 6.80    |
| 1              | 3               | "2019-04-14"      | 2.50    |

***


**3. How much revenue was generated by each store in April 2019?**
```sql
SELECT sales_outlet_id, SUM(CAST(RIGHT(current_retail_price, LENGTH(current_retail_price) - 1) AS numeric) * quantity) AS revenue
FROM operations.transactions AS ot
INNER JOIN operations.products AS op
ON ot.product_id = op.product_id
GROUP BY sales_outlet_id
ORDER BY sales_outlet_id;
```
Answer:
| sales_outlet_id | revenue   |
|-----------------|-----------|
| 3               | 77440.73  |
| 5               | 77355.97  |
| 8               | 79708.70  |

***

**4. How much revenue was generated by each store in each week of April 2019?**
```sql
SELECT sales_outlet_id, SUM(CAST(RIGHT(current_retail_price, LENGTH(current_retail_price) - 1) AS numeric) * quantity) AS revenue
FROM operations.transactions AS ot
INNER JOIN operations.products AS op
ON ot.product_id = op.product_id
GROUP BY sales_outlet_id
ORDER BY sales_outlet_id;
```
Answer:
| sales_outlet_id | week | revenue |
|-----------------|------|---------|
| 3               | 14   | 17472.50|
| 3               | 15   | 16672.30|
| 3               | 16   | 21550.58|
| 3               | 17   | 19126.25|
| 3               | 18   | 2619.10 |
| 5               | 14   | 15947.13|
| 5               | 15   | 19442.70|
| 5               | 16   | 18405.94|
| 5               | 17   | 21542.50|
| 5               | 18   | 2017.70 |
| 8               | 14   | 17330.65|
| 8               | 15   | 21775.24|
| 8               | 16   | 21478.65|
| 8               | 17   | 17284.21|
| 8               | 18   | 1839.95 |

***

**5. Is the daily inventory table accurate? The daily_inventory_pastry table has a quantity_sold field. This shows how many of each pastry were sold in each store on each day. Ideally, this should tally with the actual transactions of pastries sold in the transactions table. But we aren’t sure if it does.**

```sql
SELECT * 
FROM
	(SELECT od.*, quantity_sold_trans,
	CASE 
		WHEN quantity_sold = quantity_sold_trans THEN 1
		ELSE 0
	END AS match
	FROM
		(SELECT sales_outlet_id, transaction_date, product_id, SUM(quantity) AS quantity_sold_trans
		FROM operations.transactions
		GROUP BY sales_outlet_id, transaction_date, product_id
		ORDER BY sales_outlet_id, transaction_date, product_id) AS sub
	INNER JOIN operations.daily_inventory_pastry AS od
	ON sub.sales_outlet_id = od.sales_outlet_id AND sub.transaction_date = od.transaction_date AND sub.product_id = od.product_id) AS subsub
WHERE match = 0;
```
Answer:
First 10 rows:
| sales_outlet_id | transaction_date | product_id | start_of_day | quantity_sold | quantity_sold_trans | match |
|-----------------|-------------------|------------|--------------|---------------|---------------------|-------|
| 3               | 2019-04-01        | 69         | 18           | 8             | 10                  | 0     |
| 3               | 2019-04-01        | 70         | 18           | 12            | 9                   | 0     |
| 3               | 2019-04-01        | 72         | 48           | 9             | 2                   | 0     |
| 3               | 2019-04-01        | 73         | 18           | 9             | 4                   | 0     |
| 3               | 2019-04-02        | 70         | 18           | 10            | 7                   | 0     |
| 3               | 2019-04-02        | 71         | 18           | 10            | 11                  | 0     |
| 3               | 2019-04-02        | 72         | 48           | 10            | 9                   | 0     |
| 3               | 2019-04-03        | 70         | 18           | 5             | 11                  | 0     |
| 3               | 2019-04-03        | 71         | 18           | 4             | 9                   | 0     |
| 3               | 2019-04-03        | 73         | 18           | 15            | 5                   | 0     |

From the query output, there are many 0s present in the match column which means quantity_bought from transactions table does not match quantity_sold from the daily_inventory_pastry table does not match. Thus, the quantity_sold column is dirty with 138 rows not matching.

***

**6. Which pastry should each outlet we stop selling? Pastries that can’t be sold at the end of each day are wasted. Which pastry had the most waste in April 2019?** 
```sql
SELECT * 
FROM
	(SELECT *, RANK() OVER(PARTITION BY sales_outlet_id ORDER BY waste DESC) AS Ranking
	FROM
		(SELECT sales_outlet_id, product_id, SUM(start_of_day - quantity_sold) AS waste
		FROM operations.daily_inventory_pastry
		GROUP BY sales_outlet_id, product_id
		ORDER BY sales_outlet_id, SUM(start_of_day - quantity_sold) DESC) AS sub) AS subsub
WHERE Ranking = 1;
```
Answer:
| sales_outlet_id | product_id | waste | ranking |
|-----------------|------------|-------|---------|
| 3               | 72         | 713   | 1       |
| 5               | 72         | 747   | 1       |
| 8               | 72         | 676   | 1       |

From the output above, all 3 stores should stop selling product_id 72 since it generated the most waste in all 3 stores.

***

**7. What are the top 3 products for each store? What are the top 3 products sold in each store in April 2019 (according to revenue generated)?**
```sql
SELECT *
FROM
	(SELECT *, RANK() OVER(PARTITION BY sales_outlet_id ORDER BY total_r DESC) AS ranking
	FROM
		(SELECT sales_outlet_id, product_id, SUM(quantity) AS total_q, SUM(revenue) AS total_r
		FROM
			(SELECT op.*, ot.quantity, ot.sales_outlet_id, CAST(RIGHT(current_retail_price, LENGTH(current_retail_price) - 1) AS numeric) * quantity AS Revenue
			FROM operations.products AS op
			INNER JOIN operations.transactions AS ot
			ON op.product_id = ot.product_id) AS sub
		GROUP BY sales_outlet_id, product_id
		ORDER BY sales_outlet_id, total_r DESC) AS subsub) AS subsubsub
INNER JOIN operations.products
ON operations.products.product_id = subsubsub.product_id
WHERE Ranking IN (1, 2, 3) 
ORDER BY sales_outlet_id;
```
Answer:
| sales_outlet_id | product_id | total_q | total_r | ranking | product_id-2 | product_group   | product_category | product_type | product              | product_desc                            | unit_of_measure | estimated_cost_price | current_retail_price | tax_exempt_yn | promo_yn |
|-----------------|------------|---------|---------|---------|--------------|-----------------|-------------------|--------------|----------------------|-----------------------------------------|-----------------|----------------------|----------------------|----------------|----------|
| 3               | 59         | 568     | 2556.00 | 1       | 59           | Beverages       | Drinking Chocolate | Hot chocolate | Dark chocolate Lg    | Slightly bitter, but still very rich.   | 16 oz           | 3.38                 | $4.50                | Y              | N        |
| 3               | 61         | 534     | 2536.50 | 2       | 61           | Beverages       | Drinking Chocolate | Hot chocolate | Sustainably Grown Organic Lg | Just pure notes of spice.              | 16 oz           | 3.56                 | $4.75                | Y              | N        |
| 3               | 39         | 503     | 2137.75 | 3       | 39           | Beverages       | Coffee            | Barista Espresso   | Latte Rg             | You will think you are in Venice when you sip this one.   | 3.0 oz          | 0.85                 | $4.25                | Y              | N        |
| 5               | 59         | 497     | 2236.50 | 1       | 59           | Beverages       | Drinking Chocolate   | Hot chocolate   | Dark chocolate Lg    | Slightly bitter, but still very rich.   | 16 oz           | 3.38                 | $4.50                | Y              | N        |
| 5               | 61         | 454     | 2156.50   | 2       | 61           | Beverages       | Drinking Chocolate   | Hot chocolate   | Sustainably Grown Organic Lg    Just pure notes of spice.              16 oz           3.56                 $4.75                Y              N        |

***

**8. How much did generations spend on average each week in each outlet? How much did each generational category of customer spend on average each week at the store?**
```sql
SELECT generation, sales_outlet_id, weeknumber, SUM(revenue) AS average_spending
FROM
	(SELECT ol.*, DATE_PART('year', ol.birth_date) AS birth_year, ot.product_id, ot.quantity, ot.sales_outlet_id, ot.transaction_date, DATE_PART('week', ot.transaction_date) AS WeekNumber, op.current_retail_price, CAST(RIGHT(current_retail_price, LENGTH(current_retail_price) - 1) AS numeric) * quantity AS Revenue, oi.generation
	FROM operations.loyalty_customers AS ol
	INNER JOIN operations.transactions AS ot
	ON ol.customer_id = ot.customer_id
	INNER JOIN operations.products AS op
	ON op.product_id = ot.product_id
	INNER JOIN operations.imported_generations AS oi
	ON oi.birth_year = DATE_PART('year', ol.birth_date)) AS sub
GROUP BY generation, sales_outlet_id, weeknumber
ORDER BY generation, sales_outlet_id, weeknumber;
```
Answer:
| Generation    | Sales_Outlet_ID | Weeknumber | Average_Spending |
|---------------|-----------------|------------|------------------|
| Baby Boomers  | 3               | 14         | 5016.25          |
| Baby Boomers  | 3               | 15         | 2705.18          |
| Baby Boomers  | 3               | 16         | 1862.11          |
| Baby Boomers  | 3               | 17         | 1658.10          |
| Baby Boomers  | 3               | 18         | 209.00           |
| Baby Boomers  | 5               | 14         | 2608.45          |
| Baby Boomers  | 5               | 15         | 1677.81          |
| Baby Boomers  | 5               | 16         | 952.75           |
| Baby Boomers  | 5               | 17         | 1530.55          |
| Baby Boomers  | 5               | 18         | 335.60           |

***

**9. Who should get the best customer award for April 2019 in each store? The best customer is one who is on the loyalty programme and frequents a store the most number of times. Who should get this? In the event of a tie, the customer that has spent the most at a store should win it.**

```sql
-- visits
SELECT sales_outlet_id, customer_id, COUNT(*) AS visits
FROM
	(SELECT DISTINCT ON (transaction_sn)*
	FROM operations.transactions
	WHERE customer_id IS NOT NULL) AS sub
GROUP BY sales_outlet_id, customer_id;

-- spending
SELECT sales_outlet_id, customer_id, SUM(spent) AS total_spent
FROM
	(SELECT sales_outlet_id, customer_id, ot.product_id, CAST(RIGHT(current_retail_price, LENGTH(current_retail_price) - 1) AS numeric) * quantity AS spent
	FROM operations.transactions AS ot
	INNER JOIN operations.products AS op
	ON ot.product_id = op.product_id) AS sub
WHERE customer_id IS NOT NULL
GROUP BY sales_outlet_id, customer_id
ORDER BY sales_outlet_id, total_spent DESC

-- combining both visits and spending
SELECT sales_outlet_id, customer_id, visits, total_spent
FROM
	(SELECT *, RANK() OVER(PARTITION BY sales_outlet_id ORDER BY visits DESC, total_spent DESC) AS ranking
	FROM
		(SELECT sub1.sales_outlet_id, sub1.customer_id, visits, total_spent
		FROM
		(SELECT sales_outlet_id, customer_id, COUNT(*) AS visits
		FROM
			(SELECT DISTINCT ON (sales_outlet_id, transaction_sn, transaction_date)*
			FROM operations.transactions
			WHERE customer_id IS NOT NULL) AS sub
		GROUP BY sales_outlet_id, customer_id) AS sub1
		INNER JOIN
		(SELECT sales_outlet_id, customer_id, SUM(spent) AS total_spent
		FROM
			(SELECT sales_outlet_id, customer_id, ot.product_id, CAST(RIGHT(current_retail_price, LENGTH(current_retail_price) - 1) AS numeric) * quantity AS spent
			FROM operations.transactions AS ot
			INNER JOIN operations.products AS op
			ON ot.product_id = op.product_id) AS sub
		WHERE customer_id IS NOT NULL
		GROUP BY sales_outlet_id, customer_id
		ORDER BY sales_outlet_id, total_spent DESC) AS sub2
		ON sub1.customer_id = sub2.customer_id AND sub1.sales_outlet_id = sub2.sales_outlet_id
		ORDER BY sub1.sales_outlet_id, visits DESC, total_spent DESC) AS sub3) AS sub4
WHERE ranking = 1;
```
Answer:
| sales_outlet_id | customer_id | visits | total_spent |
|-----------------|-------------|--------|-------------|
| 3               | 548         | 24     | 115.20      |
| 5               | 5071        | 16     | 91.80       |
| 8               | 8285        | 26     | 164.05      |

***

**10. For each store, what is the distribution of the generation of customer visits? By knowing this information, the coffeeshop management can then decide and evaluate their current marketing strategies, possibly continuing or changing it to improve customer visits in order to appeal to the generation of people who visit that particular outlet the most.**
```sql
SELECT sales_outlet_id, generation, SUM(count) AS visits
FROM
	(SELECT DISTINCT ON(customer_id)*, COUNT(*)
	FROM
		(SELECT sales_outlet_id, ot.customer_id, generation
		FROM operations.transactions AS ot
		INNER JOIN operations.imported_dates AS oid
		ON ot.transaction_date = oid.transaction_date
		INNER JOIN operations.loyalty_customers AS ol
		ON ot.customer_id = ol.customer_id
		INNER JOIN operations.imported_generations AS oig
		ON oig.birth_year = DATE_PART('year', ol.birth_date)) AS sub
	GROUP BY sub.sales_outlet_id, sub.customer_id, sub.generation) AS subsub
GROUP BY sales_outlet_id, generation
ORDER BY sales_outlet_id, SUM(count) DESC;
```
Answer:
| sales_outlet_id | generation         | visits |
|-----------------|--------------------|--------|
| 3               | "Baby Boomers"     | 2535   |
| 3               | "Gen X"            | 2419   |
| 3               | "Older Millennials"| 1762   |
| 3               | "Gen Z"            | 1093   |
| 3               | "Younger Millennials" | 784 |
| 5               | "Older Millennials"| 2473   |
| 5               | "Gen Z"            | 1621   |
| 5               | "Gen X"            | 1587   |
| 5               | "Baby Boomers"     | 1533   |
| 5               | "Younger Millennials" | 1331 |
| 8               | "Baby Boomers"     | 1951   |
| 8               | "Gen X"            | 1685   |
| 8               | "Gen Z"            | 1575   |
| 8               | "Younger Millennials" | 1264 |
| 8               | "Older Millennials"| 1239   |

From the query output, it seems outlet 3 attracts the least Younger Millenials. As such, they can do market research on what these generation like to drink and eat using surveys to bring the numbers up. They can also do so for all other stores and all other outlet as deemed neccessary.

***

**11. For each store, what are the top 3 product category did each generation of customers buy the least? Using this information, the coffeeshop can understand their customers better than sell more of the products that the customers like.**
```sql
SELECT * 
FROM
	(SELECT *, DENSE_RANK() OVER(PARTITION BY sales_outlet_id ORDER BY purchase_freq) AS ranking
	FROM
		(SELECT *, COUNT(*) AS purchase_freq
		FROM
			(SELECT sales_outlet_id, op.product_category, oig.generation 
			FROM operations.transactions AS ot
			INNER JOIN operations.products AS op
			ON ot.product_id = op.product_id
			INNER JOIN operations.loyalty_customers AS ol
			ON ol.customer_id = ot.customer_id
			INNER JOIN operations.imported_generations AS oig
			ON oig.birth_year = DATE_PART('year', ol.birth_date)) AS sub
		GROUP BY sales_outlet_id, product_category, generation
		ORDER BY sales_outlet_id, COUNT(*) ASC) AS subsub) AS subsubsub
WHERE ranking IN (1, 2, 3);
```
Answer:
| sales_outlet_id | product_category    | generation          | purchase_freq | ranking |
|-----------------|---------------------|---------------------|---------------|---------|
| 3               | "Branded"           | "Younger Millennials" | 2             | 1       |
| 3               | "Packaged Chocolate"| "Gen Z"             | 2             | 1       |
| 3               | "Loose Tea"         | "Younger Millennials" | 3           | 2       |
| 3               | "Coffee beans"      | "Younger Millennials" | 5           | 3       |
| 3               | "Coffee beans"      | "Gen Z"             | 5             | 3       |
| 5               | "Packaged Chocolate"| "Baby Boomers"      | 3             | 1       |
| 5               | "Packaged Chocolate"| "Gen X"             | 3             | 1       |
| 5               | "Branded"           | "Gen Z"             | 4             | 2       |
| 5               | "Packaged Chocolate"| "Gen Z"             | 4             | 2       |
| 5               | "Packaged Chocolate"| "Younger Millennials" | 4           | 2       |
| 5               | "Branded"           | "Baby Boomers"      | 4             | 2       |
| 5               | "Branded"           | "Younger Millennials" | 6           | 3       |
| 5               | "Loose Tea"         | "Gen X"             | 6             | 3       |
| 8               | "Packaged Chocolate"| "Older Millennials" | 1             | 1       |
| 8               | "Branded"           | "Younger Millennials" | 2             | 2       |
| 8               | "Packaged Chocolate"| "Gen Z"             | 3             | 3       |
| 8               | "Branded"           | "Gen Z"             | 3             | 3       |

From the query output, we can see that across outlets 3, 5 and 8, branded, loose tea and packages chocolate seems be the least favourite. The coffeeshop can now decide if they would want to continue with these product category as it may not profitable to do so. If they wish to continue, they can then decide the next steps forward.

***

**12. For each store, how much profits were generated for each week in April 2019? Knowing this information can help the management of the coffeeshop to see how much they have earned as well as see if they have met their pre-determined target for the month.**
```sql
SELECT sales_outlet_id, week, SUM(profit)
FROM
	(SELECT sales_outlet_id, week, (CAST(RIGHT(current_retail_price, LENGTH(current_retail_price) - 1) AS numeric) - estimated_cost_price) * quantity AS profit
	FROM operations.transactions AS ot
	INNER JOIN operations.imported_dates AS oid
	ON ot.transaction_date = oid.transaction_date
	INNER JOIN operations.products AS op
	ON op.product_id = ot.product_id) AS sub
GROUP BY sales_outlet_id, week
ORDER BY sales_outlet_id, week, SUM(profit) DESC;
```
Answer:
| sales_outlet_id | week | sum     |
|-----------------|------|---------|
| 3               | 14   | 11552.33|
| 3               | 15   | 10144.58|
| 3               | 16   | 12715.96|
| 3               | 17   | 12838.86|
| 3               | 18   | 1700.12 |
| 5               | 14   | 10322.39|
| 5               | 15   | 11937.98|
| 5               | 16   | 11574.16|
| 5               | 17   | 13850.47|
| 5               | 18   | 1287.83 |
| 8               | 14   | 11624.10|
| 8               | 15   | 13189.37|
| 8               | 16   | 12389.63|
| 8               | 17   | 10742.71|
| 8               | 18   | 1254.30 |

From the query output, it seems for each store, week 18 generated the least profit. This is due to the fact that week 18 only has 2 dates which are 29th and 30th April. Apart from that, the profit seems to be relatively constant around 10k to 13k. The coffeeshop can use these numbers to check against their own targets and make any changes to their business processess if needed.